<html>

<script src="pearlstorage.js" />
<script src="pearlupdate.js" />
<script>
debug = false

function localpearsinput(){
  return document.getElementById('localpearls');
}

function globalpearsinput(){
  return document.getElementById('globalpearls');
}
function loadedspan(){
  return document.getElementById('loaded');
}



var TimeToFade = 2000
function animateFade(lastTick, eid)
{  
  var curTick = new Date().getTime();
  var elapsedTicks = curTick - lastTick;  
  var element = document.getElementById(eid); 
  if(element.FadeTimeLeft <= elapsedTicks)
  {
    element.style.opacity = 0
    return;
  } 
  element.FadeTimeLeft -= elapsedTicks;
  var newOpVal = element.FadeTimeLeft/TimeToFade;
  element.style.opacity = newOpVal;
  setTimeout("animateFade(" + curTick + ",'" + eid + "')", 33);
}

function fade(eid)
{
  var element = document.getElementById(eid);  
  if(element == null)
    return;
  element.FadeTimeLeft = TimeToFade
  setTimeout("animateFade(" + new Date().getTime() + ",'" + eid + "')", 33);
  return;
}

function setPearls(pearltype){
  chrome.tabs.getSelected(null,function(tab) {
    setUrl(tab.url)
    localpearlsInput = document.getElementById(pearltype );
    localpearlsInput.value = getPearls(pearltype);
  });
}

function setToggle(){ 
  toggleInput = document.getElementById("toggle")
  toggled = loadToggle();  
  toggleInput.className = toggled ? 'on' : 'off';
  toggleInput.value = toggled ? "Pearl On" : "Pearl Off";  
}

function turnOnOff(){  
  toggled = loadToggle();     
  saveToggle(!toggled);  
  chrome.tabs.getSelected(null,function(tab) {
    updatePage(tab)
  })
  setToggle();
}

function mystorePearls(pearltype){
  if(debug) console.log('hey')
  
  chrome.tabs.getSelected(null,function(tab) {
    if(debug) console.log(tab.url)
    setUrl(tab.url)
    pearlvalue = document.getElementById(pearltype).value
    storePearls(pearltype,pearlvalue)    
    updatePage(tab)
    loadedspan().style.opacity = 100;
    fade('loaded')
  });
}

function myMovePage(type){
  if(debug) console.log('move')
  chrome.tabs.getSelected(null,function(tab) {
    movePage('pos',type,tab)
   });
}

function cursorend(element){
  if(debug) console.log('focused')
  /*if (element.createTextRange)
  {
    var FieldRange = element.createTextRange();
    FieldRange.moveStart('character', element.value.length);
    FieldRange.collapse();
    FieldRange.select();
    
    
  }
  element.setSelectionRange(element.value.length, element.value.length); */
  element.value = element.value;
}

function inputkeypressed(e,element){
  
  if( e.which == 13 && ( element.id == 'localpearls' ) ){
      e.preventDefault();
      globalpearsinput().focus()
      return;
  }

  if( e.which == 13 && (  element.id == 'globalpearls'  ) ){
      e.preventDefault();
      document.getElementById('moveNext').focus()
      return;
  }
  
  if( e.which == 27 ){
    e.preventDefault();
    element.blur();
  }
}

function testingPopup(evt) {
  alert('bye')
}

function main(){
  if(debug) console.log("Popup loading")
  setPearls("localpearls");
  setPearls("globalpearls");
  setToggle("toggle");
  if(debug) console.log("Popup loaded")
  localpearsinput().focus()
  window.addEventListener("unload", testingPopup, false);
 
}


</script>
<style>
body {
  width:600px;
  overflow-x:hidden;
  font-family: verdana; 
  font-size: 10px;  
}

input {
  border: solid 1px #CCC;
  font-family: verdana; 
  font-size: 10px;
}

textarea {
  border: solid 1px #CCC;
  font-family: verdana; 
  font-size: 10px;
  margin-bottom: 5px;
}

textarea:hover {
  background-color: #EEE;  
}

input:hover, input:focus {
  background-color: #EEE;  
}

.off {
  background-color: #F99;
}

.on {
  background-color: #3F9;
}

</style>

<body onload="javascript:main()" >
<form>
<div id="words">
  
</div>
<div>
  <span style="width: 120px; vertical-align:middle; height: 50px; float: left">
    This page pearls: 
  </span>
  <span style="width: 480px; height: 50px; float: right">
    <textarea tabindex=1 style="width: 480px; height: 50px;" id="localpearls" type="text" onfocus="javascript:cursorend(this)" onkeydown="javascript:inputkeypressed(event,this)" onchange="javascript:mystorePearls('localpearls')" ></textarea>
  </span>
  <span style="width: 600px; height: 5px; float: right">
  </span>
  <span style="width: 120px; vertical-align:middle; height: 50px; float: left">
    Every page pearls: 
  </span>
  <span style="width: 480px; height: 50px; float: right">
    <textarea tabindex=2 style="width: 480px; height: 50px;" id="globalpearls" type="text" onfocus="javascript:cursorend(this)" onkeydown="javascript:inputkeypressed(event,this)" onchange="javascript:mystorePearls('globalpearls')" ></textarea>
  </span>
  <span style="width: 600px; height: 5px; float: right">
  </span>
  <div style="width: 400px; vertical-align:middle; height: 30px; float: left">
    <span style="width: 150px; vertical-align:middle; height: 30px; ">
      <input tabindex=4 style="width: 100px" id="movePrev" type="button" value="Previous" onclick="javascript:myMovePage('prevHilightedNode')" />
    </span>
    <span style="width: 150px; vertical-align:middle; height: 30px; ">
      <input tabindex=3 style="width: 100px" id="moveNext" type="button" value="Next" onclick="javascript:myMovePage('nextHilightedNode')" />
    </span>
    <span style="width: 20px; vertical-align:middle; height: 30px; ">
      <input tabindex=6 style="width: 20px" id="pos" type="text" value="0" />
    </span>    
    <span  id="loaded" style="opacity: 0; width: 50px; vertical-align:middle; height: 30px; background-color: red; color: white; font-weight: bold; ">
      Pearls Saved
    </span>
  </div>  
  <span style="width: 200px; vertical-align:middle; height: 30px; float: right">
    <input tabindex=5 style="width: 200px" id="toggle" type="button" onclick="javascript:turnOnOff()" />
  </span>
</div>
</form>
</body>
</html>